DATA SEGMENT
DATA ENDS
STACK SEGMENT STACK
STA DW 200 DUP(?)
STACK ENDS
CODE SEGMENT
ASSUME CS:CODE,DS:DATA,SS:STACK
MOV AX,DATA
MOV DS,AX

START:
MOV DX,256H;初始化28255，8255起始地址250H,控制口地址256H
MOV AL,10011000B ;A口用于输入方式0
OUT DX,AL
MOV AL,01H;使pc0=1，选通无效
MOV DX,256H
OUT DX,AL
;8255初始化完成

MOV DX, 262H
MOV AL,00H
OUT DX,AL
MOV AL,40H
OUT DX,AL;内部复位
NOP
MOV AL,0FAH  ;模式字初始化28251，初始地址260H ,状态控制口262H
MOV DX,262H
OUT DX,AL
MOV AL,37H    ; 控制字
MOV DX,262H
OUT DX,AL
;28251初始化完成

MOV AL,11H;主片初始化，首地址230H,ICW1控制字，边沿触发，设置icw4
MOV DX,230H;主片8259初始地址230H；
OUT DX,AL ;icw1
MOV AL,0;中断类型号为0,高五位为00000，低三位为000
MOV DX,232H
OUT DX,AL ; icw2
MOV AL,01H
MOV DX,232H
OUT DX,AL;icw3
MOV AL,13H ;中断自动结束
MOV DX,232H
OUT DX,AL;icw4
;主片初始化完成

MOV AL,00010001B;从片8259初始化，初始地址为240H,边沿触发，级联
MOV DX,240H
OUT DX,AL ;icw1
MOV AL, 1;中断类型号为1
MOV DX,242H
OUT DX,AL;icw2
MOV AL,00H;
MOV DX,242H
OUT DX,AL;icw3，接到主片IR0
MOV AL,00010001B;不自动结束，非缓冲，特殊全嵌套
MOV DX,242H
OUT DX,AL ;icw4
;从片初始化完成

MOV AX,0
MOV DS,AX  ;清零
LEA AX,INT1
MOV DS:[1*4],AX;中断服务程序的入口地址偏移量=中断类型号*4
MOV AX,CS
MOV DS:[1*4]+2,AX;中断服务程序的入口地址段地址=中断类型号*4+2
LEA AX,INT2;第二个中断子程序的中断向量
MOV DS:[2*4],AX
MOV AX,CS
MOV DS:[2*4]+2,AX
;送中断向量完成

MOV DX,232H ;主片
IN AL,DX ;读主片中断屏蔽寄存器IMR
AND AL,11101110B;开放中断IR4和IR0
OUT DX,AL 
MOV AL,0DH
MOV DX,236H
OUT DX,AL;使pc6为0，允许主片8255A中断
STI; 主片开中断
MOV DX,242H;从片
IN AL,DX;读从片中断寄存器
AND AL,11101001B;开放中断IR4和IR1,IR2
OUT DX,AL
MOV AL,0DH
MOV DX,246H
OUT DX,AL;从片pc6为0，允许中断
STI;从片开中断

REPEAT:HLT
JMP REPEAT;等待
;中断子程序
INT1 PROC FAR ;接受18255发来的数据
RECEIVE:
MOV DX,254H;28255的c口地址
IN AL,DX
AND AL,10H;查询pc4是否为0
JNZ RECEIVE
MOV DX,250H;从a口接收数据
MOV BX,300H;接收的数据存放在cpu2的300H+地址里
IN AL,DX
MOV [SI+BX],AL

  MOV AL,00
  MOV DX,246H
  OUT DX,AL;使pc0为0，产生选通信号
INC SI;指针加一
  MOV DX,246H
  OUT DX,AL;使pc0为1，撤销选通信号 
  MOV AL,01H;使pc0=1;
MOV DX,240H
MOV AL,20H ;从片ocw2发结束命令EOI=1
OUT DX,AL
STI
IRET
INT1 ENDP
INT2 PROC FAR
SEND:
MOV DX,300H;取缓存区首地址
MOV DX,262H;状态口
IN AL,DX;查状态位发送引脚TXRDY
TEST AL,38H;查错误
;JNZ ERROR
AND AL,01H;未准备好则等待
JZ SEND
MOV DX,260H
MOV AL,[SI+BX];发送
OUT DX,AL 
  MOV AL,00
  MOV DX,246H
  OUT DX,AL;使pc0为0，产生选通信号
INC SI
  MOV DX,246H
  OUT DX,AL;使pc0为1，撤销选通信号 
  MOV AL,01H;使pc0=1;
MOV DX,242H;8259奇地址
MOV AL,20H;ocw2发结束命令EOI=1;
OUT DX,AL
STI
IRET
INT2 ENDP
CODE ENDS
END START